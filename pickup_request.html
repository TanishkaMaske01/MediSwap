<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MediSwap | Request Pickup</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
        }
        .text-primary { color: #059669; }
        .bg-primary { background-color: #059669; }
        .bg-secondary { background-color: #34d399; }
        .btn-primary {
            transition: all 0.2s ease-in-out;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }
        .btn-primary:hover {
            background-color: #047857;
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
        }
        /* Simple spinner animation */
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .loader {
            border-top-color: #34d399;
            -webkit-animation: spin 1s ease-in-out infinite;
            animation: spin 1s ease-in-out infinite;
        }
    </style>
</head>
<body class="text-gray-800 flex flex-col min-h-screen">

    <!-- Header & Navigation -->
    <header class="shadow-md bg-white sticky top-0 z-10">
        <nav class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
            <h1 class="text-3xl font-extrabold text-primary">MediSwap</h1>
            <div class="space-x-4">
                <a href="index.html" class="hover:text-primary transition font-medium">Home</a>
                <a href="login.html" class="hover:text-primary transition font-medium">Logout</a>
            </div>
        </nav>
    </header>

    <!-- Pickup Request Form (CTA Section) -->
    <main class="flex-grow py-16 bg-gradient-to-r from-emerald-50 to-white">
        <div class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8">
            <h2 class="text-4xl font-bold text-center text-gray-900 mb-4">Request Your Medicine Pickup</h2>
            <p class="text-xl text-center text-gray-600 mb-10">Please provide accurate details so our team can efficiently schedule your collection.</p>

            <form id="pickupForm" class="bg-white p-8 rounded-xl shadow-2xl border border-gray-100">
                <div class="space-y-6">
                    <!-- Name -->
                    <div>
                        <label for="name" class="block text-lg font-medium text-gray-700">Your Full Name</label>
                        <input type="text" id="name" required class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:ring-primary focus:border-primary">
                    </div>

                    <!-- Contact -->
                    <div>
                        <label for="contact" class="block text-lg font-medium text-gray-700">Phone Number or Email</label>
                        <input type="text" id="contact" required class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:ring-primary focus:border-primary">
                    </div>

                    <!-- Address -->
                    <div>
                        <label for="address" class="block text-lg font-medium text-gray-700">Full Rural Address / Location Details</label>
                        <textarea id="address" rows="3" required class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:ring-primary focus:border-primary"></textarea>
                        <p class="mt-2 text-sm text-gray-500">Please include village name, district, and any nearby landmarks.</p>
                    </div>

                    <!-- Type of Medicine -->
                    <div>
                        <label for="medicineType" class="block text-lg font-medium text-gray-700">Briefly Describe the Medicine to be Collected</label>
                        <input type="text" id="medicineType" required class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:ring-primary focus:border-primary">
                        <p class="mt-2 text-sm text-gray-500">e.g., "Two boxes of expired pain medication," "A mix of old pills and syrups."</p>
                    </div>

                    <!-- Submit Button -->
                    <button type="submit" id="submitButton" class="w-full btn-primary flex justify-center items-center px-6 py-3 border border-transparent text-lg font-medium rounded-xl text-white bg-primary hover:bg-secondary focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary">
                        Submit Pickup Request
                    </button>
                    
                    <!-- Feedback Message -->
                    <div id="feedback" class="mt-4 text-center font-semibold p-3 rounded-lg hidden"></div>
                </div>
            </form>
        </div>
    </main>

    <!-- Footer with added links -->
    <footer class="bg-gray-800 text-white py-10">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
            <p class="mb-4 text-lg font-semibold">MediSwap | Safe Disposal. Healthy Communities.</p>
            <div class="space-x-4 text-sm text-gray-400">
                <a href="#contact" class="hover:text-primary">Contact Us</a>
                <span class="text-gray-600">|</span>
                <a href="#privacy" class="hover:text-primary">Privacy Policy</a>
                <span class="text-gray-600">|</span>
                <a href="#security" class="hover:text-primary">Security</a>
            </div>
            <p class="mt-4 text-sm text-gray-400">Â© 2024 MediSwap Project. All rights reserved.</p>
        </div>
    </footer>

    <script>
        const form = document.getElementById('pickupForm');
        const submitButton = document.getElementById('submitButton');
        const feedbackDiv = document.getElementById('feedback');
        
        // --- API Configuration ---
        const API_URL = 'http://127.0.0.1:5000/submit-pickup';

        function showLoading() {
            submitButton.disabled = true;
            feedbackDiv.classList.add('hidden');
            submitButton.innerHTML = `
                <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-6 w-6 mr-3"></div>
                Sending Request...
            `;
        }

        function resetFormState() {
            submitButton.disabled = false;
            submitButton.innerHTML = 'Submit Pickup Request';
        }

        function displayFeedback(message, type) {
            feedbackDiv.classList.remove('hidden', 'bg-green-100', 'text-primary', 'bg-red-100', 'text-red-700');
            
            if (type === 'success') {
                feedbackDiv.classList.add('bg-green-100', 'text-primary');
                feedbackDiv.innerHTML = `<p><strong>Success!</strong> ${message}</p>`;
            } else {
                feedbackDiv.classList.add('bg-red-100', 'text-red-700');
                feedbackDiv.textContent = `Error: ${message}`;
            }
        }


        // Handle form submission and send data to the backend
        form.addEventListener('submit', async function(event) {
            event.preventDefault();
            
            showLoading();

            const name = document.getElementById('name').value;
            const contact = document.getElementById('contact').value;
            const address = document.getElementById('address').value;
            const medicineType = document.getElementById('medicineType').value;
            
            const formData = {
                name: name,
                contact: contact,
                address: address,
                medicineType: medicineType,
                timestamp: new Date().toISOString()
            };

            // Declare response outside the loop
            let response; 

            try {
                // Implementing basic exponential backoff for robustness
                const MAX_RETRIES = 3;
                
                for (let attempt = 0; attempt < MAX_RETRIES; attempt++) {
                    try {
                        response = await fetch(API_URL, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(formData)
                        });
                        if (response.ok || response.status < 500) break; // Break on success or client error
                        
                        // Wait before retrying (exponential backoff)
                        await new Promise(resolve => setTimeout(resolve, Math.pow(2, attempt) * 1000));
                    } catch (e) {
                        // If it's a network error, wait and retry
                        if (attempt === MAX_RETRIES - 1) throw e;
                        await new Promise(resolve => setTimeout(resolve, Math.pow(2, attempt) * 1000));
                    }
                }

                if (response && response.ok) {
                    const data = await response.json();
                    
                    // --- REDIRECT TO INTERMEDIATE SUCCESS PAGE ---
                    // Pass the request ID in the URL for tracking
                    window.location.href = `pickup_success.html?id=${data.request_id}&status=success`;
                    
                } else if (response) {
                    const errorData = await response.json();
                    displayFeedback(`Request failed: ${errorData.error || 'Server rejected the data.'} (HTTP Status: ${response.status})`, 'error');
                } else {
                    displayFeedback(`Could not connect to the server (Python backend) after multiple attempts. Please ensure the backend is running at ${API_URL}`, 'error');
                }
            } catch (error) {
                console.error('Submission Error (Network or CORS Failure):', error);
                // Improved message to guide the user to the most likely local issue
                displayFeedback(`CRITICAL ERROR: Could not connect to the backend server. Please check your console for details and **ensure the Python app (app.py) is running** on ${API_URL}.`, 'error');
            } finally {
                // Only reset form state if we didn't redirect (e.g., on failure)
                if (!response || !response.ok) {
                    resetFormState();
                }
            }
        });
    </script>
</body>
</html>
